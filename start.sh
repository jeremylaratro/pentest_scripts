#!/bin/bash
opts='i:d:x:nlbawsh'
while getopts $opts arg; do
  case $arg in
    i ) ip=$OPTARG;;
    d ) domain=$OPTARG;;
    l ) lfi=1;;
    s ) sub=1;;
    w ) web=1;;
    n ) nmap=1;;
    a ) all=1;;
    b ) smb=1;;
    h ) usage; exit 1;;
    * ) echo "unknown argument";;
  esac
done

# Shows the simple usage / syntax
usage() {
  echo "This is a simple script to streamline inital discovery and enumeration. "
  echo "Usage:
       $0 -i ip_addr -n nmap -d domain -l lfi scan=enabled -b smb scan -s subdomain discovery=enabled"
  echo "Write access is required within the directory from which the script is run."
}
what()
  if [ ! -z "$domain" ]
  then
    whatweb $domain
  else
    whatweb http://$ip
  fi

nmap_run() {
  nmap -vv -sV --top-ports 600 $ip -oG $LOGFILE
  echo "Nmap scan complete"
}

web_server() {
  gobuster dir -u http://$ip --wordlist /usr/share/dirb/wordlists/big.txt -x php,txt,js,html -o $LOGFILE
  echo "Web server scan complete" -v
}

smb_scan() {
  cat $LOGFILE | grep 139 | greprc=$?
  if [[ $greprc -eq 0 ]]; then
    echo "Found open SMB ports"
    enum4linux $ip
  fi
}

# still developing this function
lfi_scan() {
  cat $LOGFILE | grep php | sed -e's,^\(.* (\).*,\1,g' | cut -d ' ' -f1 > tmp.txt
  file=$(cat tmp.txt)
  for line in $file; do
    gobuster fuzz --url http://$ip/$line/?file=FUZZ -w /usr/share/wordlists/SecLists-master/Fuzzing/LFI/LFI-LFISuite-pathtotest-huge.txt -b 404,400 -o lfi_output.txt
  done
}

lfi_analysis() {
  echo "Full LFI output file available at lfi_output.txt"
  echo "Starting LFI output analysis for interesting results"
  nums="[0-9]+"
  for i in 200 201 202 302 301 304 305 307 308; do   
    stat=$(cat lfi_output.txt | grep -o Status=$i |   wc -l)
    echo "Status code ($i): " $stat
  done
  res=$(cat lfi_output.txt | grep -rohP Length=[0-9\.]+ | sort -u)
  for nums in $res; do
    occ=$(echo $nums && cat lfi_output.txt | grep $nums | wc -l)
    echo "Length frequencies (Length | Frequency): "$occ
  done
  echo "The results of this output are best analyzed manually; try searching for the least frequent results first."
  echo "For example: cat lfi_output.txt | grep Length=<output with least ocurrence>"
}


subd() {
  if [ ! -z "$domain" ]
  then
    sublist3r -d $domain
    dig ANY $domain @$ip
    dig ANY $domain
  else
	
    dig ANY $ip
  fi
}

# start function create the output file to which the scans will be written. 
start() {
  echo "Starting in.."
  for i in {3..1}
  do
    echo -n "$i........."
    sleep 1
  done
  echo " "
  touch initial_scans.txt
  LOGFILE=initial_scans.txt
  echo "Output available at $LOGFILE"
}

#main function runs the scan functions after usage info and initilization has completed. 
main() {

  usage
  start
  what
  if [ ! -z "$nmap" ]
  then
    echo "Starting inital nmap scan on $ip using top 200 ports."
    nmap_run
  fi
  
  if [ ! -z "$sub" ]
  then
    echo "Starting subdomain discovery"
    subd
  fi
  
  if [ ! -z "$smb" ]
  then
    smb_scan
  fi
  
  if [ -n "$web" ]
  then
    echo "Starting directory enumeration on http://$ip"
    web_server
  fi
  
  if [ ! -z "$lfi" ]
  then
    echo "Starting PHP/LFI scan"
    lfi_scan
    lfi_analysis
  fi
  
  if [ ! -z "$all" ]
  then
    echo "All commands enabled"
    what
    nmap_run
    web_server
    subd
    smb_scan
    lfi_scan
    lfi_analysis
  fi

 }
main

